---
name: review-pr
description: PR の差分をレビューし、バグ・スタイル・セキュリティの問題を指摘する。PR 作成後のレビューや、ユーザーが「/review-pr」「PR をレビューして」「コードレビューお願い」と言ったときに使う。PR 番号の指定がなければ現在のブランチの PR を自動検出する。
---

# Review PR

Pull Request のコードレビューを行うスキル。差分を取得し、複数の観点から問題を発見・分類して報告する。

## 引数の解析

- `/review-pr` → 現在のブランチに紐づく PR を自動検出
- `/review-pr 5` or `/review-pr #5` → PR #5 をレビュー

## ワークフロー

### Step 1: PR の特定

引数がなければ現在のブランチの PR を探す:

```bash
gh pr view --json number,title,body,url
```

引数があればその番号を使う:

```bash
gh pr view <番号> --json number,title,body,url
```

### Step 2: 差分の取得

```bash
gh pr diff <番号>
```

差分が大きい場合はファイル単位で読み進める。

### Step 3: コードレビュー

差分を以下の観点でレビューする:

**バグ・ロジック:**
- エッジケースの見落とし
- None/null の未処理
- 非同期処理の問題
- 型の不整合

**スタイル・品質:**
- CLAUDE.md のコーディング規約との整合性
- 関数・変数の命名（スネークケース / パスカルケース）
- 不要なコードやコメント
- 型ヒントの欠落

**セキュリティ:**
- ハードコードされた秘密情報
- SQL インジェクション等の脆弱性
- ユーザー入力のバリデーション不足
- `.env` が含まれていないか

**設計:**
- 既存アーキテクチャとの一貫性
- 単一責任原則
- テストの十分性

### Step 4: 結果の分類

発見した問題を3カテゴリに分類する:

1. **必須修正** — バグやセキュリティ問題。この PR ですぐ直すべきもの
2. **推奨修正** — コード品質の改善。今回直せるなら直したいもの
3. **将来の課題** — 大きなリファクタリングが必要。Issue を作成して追跡するもの

### Step 5: PR にレビューコメントを投稿

レビュー結果を PR のコメントとして投稿する。レビュー内容を記録として残すために、チャットでの報告だけでなく必ず PR にも投稿すること。

```bash
gh pr comment <番号> --body "$(cat <<'EOF'
## コードレビュー結果

### 必須修正
- <指摘内容>（なければ「なし」）

### 推奨修正
- <指摘内容>（なければ「なし」）

### 将来の課題
- <指摘内容>（なければ「なし」）
EOF
)"
```

問題がなければ「レビュー問題なし」と投稿する。

### Step 6: Issue の作成（将来の課題がある場合）

「将来の課題」に分類された問題は GitHub Issue を作成する:

```bash
gh issue create --title "<問題の簡潔な説明>" --body "$(cat <<'EOF'
## 背景
PR #<番号> のレビューで発見された問題。

## 問題の詳細
<指摘内容の詳細>

## 対応案
<推奨する対応方針>
EOF
)"
```

作成した Issue の番号と URL を PR コメントに追記、またはチャットで報告する。

### Step 7: 次のアクション提案

- 修正が必要な場合: `/fix-review` の実行を提案する
- 問題がない場合: ユーザーにマージ確認を促す
