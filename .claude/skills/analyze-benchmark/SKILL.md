# Analyze Benchmark

ベンチマーク結果の JSON を読み込み、LLM の行動品質を多角的に分析して具体的な改善アクションを提案する。

## 引数の解析

ユーザーの入力から結果ファイルのパスを抽出する:

- `/analyze-benchmark` → `benchmark_results/` 内の最新ファイルを自動検出
- `/analyze-benchmark benchmark_results/result_20260223.json` → 指定ファイル

## ログフォーマット

ベンチマーク結果の `games[].log` には以下の形式でゲームログが含まれる:

| プレフィックス | 形式 | 説明 |
|---------------|------|------|
| `[配役]` | `[配役] Alice: villager` | 役職の割り当て |
| `[発言]` | `[発言] Alice: こんにちは` | 議論での発言 |
| `[投票]` | `[投票] Alice → Bob` | 投票行動 |
| `[処刑]` | `[処刑] Alice が処刑された（得票数: 3）` | 処刑結果 |
| `[襲撃]` | `[襲撃] Alice が人狼に襲撃された` | 人狼の襲撃結果 |
| `[占い]` | `[占い] Alice が Bob を占った` | 占い師の占い行動 |
| `[占い結果]` | `[占い結果] Alice の占い: Bob は 白` | 占い結果（白/黒） |

分析時はこれらのプレフィックスでログエントリを分類し、各ステップで活用する。

## ワークフロー

### Step 1: 結果ファイルの読み込み

指定された JSON ファイル、または `benchmark_results/` 内の最新ファイルを読み込む。
`games[].log` にゲームログが含まれているか確認し、含まれていない場合は Step 4〜7 をスキップしてユーザーに通知する。

### Step 2: 勝率分析

- 陣営別勝率の評価
- Random との差分（比較データがある場合）
- LLM がどの程度「賢く」プレイできているかの評価

### Step 3: ゲーム展開分析

- ターン数の分布
- 人狼の発見されやすさ（何ターン目に処刑されるか）
- 各ゲームの勝敗パターン

### Step 4: 発言内容の分析

ログの `[配役]` と `[発言]` エントリを用いて、各プレイヤーの発言を役職別に評価する。

- **論理性・一貫性**: 発言が前後で矛盾していないか、議論の流れに沿っているか
- **役職適合性**: 役職に応じた適切な発言ができているか
  - 村人: 論理的な推理に基づいて怪しいプレイヤーを指摘できているか
  - 占い師: 占い結果を効果的に活用した発言ができているか（公表タイミング含む）
  - 人狼: 村人のふりが自然にできているか、疑いを他のプレイヤーに向けられているか
- **人狼の偽装品質**: 人狼プレイヤーの発言が不自然に防御的・攻撃的でないか
- **ゲーム全体の傾向**: 複数ゲームを通じた発言パターンの偏りや定型化

### Step 5: 投票行動の分析

ログの `[投票]`、`[占い結果]`、`[配役]` エントリを照合して投票行動を評価する。

- **占い結果の活用**: 占い結果が公開された後の投票で、結果を反映した投票ができているか
- **村人陣営の団結**: 村人陣営が情報を共有して人狼に集中投票できているか
- **人狼の偽装**: 人狼が不自然な投票（仲間を守る投票、情報と矛盾する投票）をしていないか
- **投票の分散**: 票が分散して人狼が生き残るパターンの頻度

### Step 6: 夜行動の合理性分析

ログの `[占い]`、`[襲撃]`、`[配役]` エントリを用いて夜行動を評価する。

- **占い師の占い対象選択**:
  - 発言が怪しいプレイヤーや情報が少ないプレイヤーを優先しているか
  - 既に信頼度が高い（白確定の）プレイヤーを無駄に占っていないか
- **人狼の襲撃対象選択**:
  - 占い師を早期に排除しようとしているか
  - 自分を疑っているプレイヤーを排除する戦略的判断ができているか
  - 襲撃対象の選択に一貫した戦略があるか

### Step 7: プロンプト改善案の提示

Step 4〜6 の分析結果に基づき、`src/llm_werewolf/engine/prompts.py` への具体的な修正方針を提案する。

- **`_ROLE_INSTRUCTIONS` の改善案**:
  - 各役職（`VILLAGER` / `SEER` / `WEREWOLF`）の指示文に追加すべき戦略的ガイダンス
  - 発言・投票・夜行動で確認された弱点に対する補強
- **アクション別プロンプトの改善案**:
  - `build_discuss_prompt`: 発言品質を向上させるための追加指示
  - `build_vote_prompt`: 投票判断の根拠を明確にするための追加指示
  - `build_divine_prompt`: 占い対象選択の戦略性を高めるための追加指示
  - `build_attack_prompt`: 襲撃対象選択の戦略性を高めるための追加指示
- **具体的な修正例**: 可能な限りプロンプト文案を提示する

### Step 8: API パフォーマンス分析

- アクション種別ごとのレイテンシ（結果 JSON から読み取れる場合）
- 総 API 呼び出し回数
- 推定コスト（モデル名からトークン単価を概算）

### Step 9: 改善提案

分析結果に基づき、以下の観点で改善を提案する:

- **プロンプト改善**: Step 7 の改善案を踏まえた優先度付きアクションリスト
- **パラメータ調整**: temperature の変更提案
- **新機能提案**: 必要に応じて `/create-issue` で Issue 化

### Step 10: レポート出力

分析結果をマークダウン形式でユーザーに報告する。
