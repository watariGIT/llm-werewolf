---
name: review-pr
description: PR の差分を最大5種のレビュアー観点でレビューする。PR 作成後のレビューや、ユーザーが「/review-pr」「PR をレビューして」「コードレビューお願い」と言ったときに使う。PR 番号の指定がなければ現在のブランチの PR を自動検出する。
---

# Review PR

Pull Request のコードレビューを行うスキル。差分を取得し、変更内容に応じて最大5種のレビュアーを選定してレビューする。

## 引数の解析

- `/review-pr` → 現在のブランチに紐づく PR を自動検出
- `/review-pr 5` or `/review-pr #5` → PR #5 をレビュー

## レビュアー一覧

各レビュアーの詳細なチェック観点は `reviewers/` ディレクトリの個別ファイルに定義されている。

| # | レビュアー | 定義ファイル | 対象の判定基準 |
|---|-----------|------------|--------------|
| 1 | コード品質 | `reviewers/code-quality.md` | `.py` または `templates/*.html` 変更あり |
| 2 | 設計・ドキュメント | `reviewers/design-docs.md` | `.py` 変更あり |
| 3 | ルール整合性 | `reviewers/rule-consistency.md` | `domain/`, `engine/`, `session.py` のいずれかに変更あり |
| 4 | デザイナー | `reviewers/designer.md` | `templates/`, `static/`, `.html`, `.css`, `.js` 変更あり |
| 5 | LLM統合 | `reviewers/llm-integration.md` | `engine/` 配下の LLM 関連ファイル変更あり（`llm_config.py`, `response_parser.py`, `*provider*.py`（`random_provider.py` 除く）, `*prompt*`） |

## ワークフロー

### Step 1: PR の特定

引数がなければ現在のブランチの PR を探す:

```bash
gh pr view --json number,title,body,url
```

引数があればその番号を使う:

```bash
gh pr view <番号> --json number,title,body,url
```

### Step 2: 差分の取得

```bash
gh pr diff <番号>
```

差分が大きい場合はファイル単位で読み進める。

### Step 3: レビュアーの決定

差分の変更ファイル一覧から、どのレビュアーを起動するか判定する。

判定ルール:

1. `.py` ファイルまたは `templates/*.html` の変更あり → **コード品質** + **設計・ドキュメント**
2. `domain/`, `engine/`, `session.py` のいずれかに変更あり → 上記に加えて **ルール整合性**
3. `engine/` 配下の LLM 関連ファイル変更あり → **LLM統合**
4. `templates/`, `static/`, `.html`, `.css`, `.js` の変更あり → **デザイナー**

判定結果を以下の形式でユーザーに表示してからレビューを開始する:

```
該当レビュアー:
- [x] コード品質
- [x] 設計・ドキュメント
- [ ] ルール整合性
- [ ] デザイナー
- [ ] LLM統合
```

### Step 4: 各レビュアーによる並列レビュー実行

**Task ツールで該当する各レビュアーをサブエージェントとして並列に起動すること。**

手順:

1. 該当する各レビュアーの定義ファイル（`reviewers/*.md`）を Read ツールで読み込む
2. 各レビュアーを `Task` ツール（`subagent_type: Explore`, `model: haiku`, `max_turns: 10`）で並列に起動する
   - 1つのメッセージで複数の Task 呼び出しを行い、並列実行する
3. 各サブエージェントのプロンプトには以下を **すべて** 含める:
   - PR 番号と **差分の全文**（サブエージェントが自分でファイルを読み直す必要をなくすため）
   - レビュアー定義ファイルから読み込んだ **チェック観点の全文**
   - 「発見した問題を critical / warning / info に分類して報告せよ。問題がなければ "✅ 問題なし" とだけ返せ」という指示
   - 「差分に含まれる変更のみをレビューせよ。差分外のコードの改善提案は不要」という指示
4. 全サブエージェントの結果が返ってきたら Step 5 に進む

#### レビュー対象外（自動チェック済み）

以下はレビュー前に `uv run tox` で通過済みのため、レビューでは指摘しない。**サブエージェントがテストやリントを実行することも禁止する。** テスト結果が必要な場合は、ローカル実行結果をユーザーから受け取るか、CI の結果を `gh pr checks <番号>` で確認する。

- **ruff format** — コードフォーマット（インデント、空行、引用符スタイル等）
- **ruff check** — リント違反（未使用インポート、命名規則等）
- **mypy** — 型ヒントの欠落、型の不整合
- **pytest** — テストの通過・失敗（テストが十分かどうかは別途レビュー対象）

### Step 5: 結果の分類

発見した問題を3レベルに分類する:

1. **🔴 critical** — バグ・セキュリティ・ルール不整合。この PR で必ず修正すべき
2. **🟡 warning** — 品質改善。今回直せるなら直したい
3. **🔵 info** — 参考情報・将来の課題。Issue を作成して追跡

### Step 6: PR にレビューコメントを投稿

レビュー結果を PR のコメントとして投稿する。レビュー内容を記録として残すために、チャットでの報告だけでなく必ず PR にも投稿すること。

該当したレビュアーのセクションのみ含める。各セクション内で指摘をレベル別に記載し、最後にサマリーテーブルでまとめる:

```bash
gh pr comment <番号> --body "$(cat <<'EOF'
## コードレビュー結果

### コード品質レビュー
- 🔴 critical: <指摘内容>
- 🟡 warning: <指摘内容>
- 🔵 info: <指摘内容>
（指摘なし → ✅ 問題なし）

### 設計・ドキュメントレビュー
- ✅ 問題なし

### ルール整合性レビュー
- 🔵 info: <指摘内容>

### デザイナーレビュー
- ✅ 問題なし

### LLM統合レビュー
- ✅ 問題なし

---

### サマリー
| レベル | 件数 |
|--------|------|
| 🔴 critical | N |
| 🟡 warning | N |
| 🔵 info | N |
EOF
)"
```

全レビュアーで問題がなければ「✅ レビュー問題なし」と投稿する。

### Step 7: Issue の作成（info レベルの課題がある場合）

info レベルの課題がある場合、`/create-issue` スキルを使って Issue を作成する。

課題ごとに以下の情報を `/create-issue` に渡す:

- **ゴール**: 指摘された課題の解決
- **背景**: PR #<番号> のレビューで発見された課題であること、指摘内容の詳細
- **変更方針**: 推奨する対応方針
- **対応時期**: 将来の改善課題としての適切な対応時期

作成した Issue の番号と URL を PR コメントに追記、またはチャットで報告する。

### Step 8: 次のアクション提案

- 修正が必要な場合: `/fix-review` の実行を提案する
- 問題がない場合: ユーザーにマージ確認を促す
