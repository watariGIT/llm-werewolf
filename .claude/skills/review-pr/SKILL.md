---
name: review-pr
description: PR の差分を6種のレビュアー観点でレビューする。PR 作成後のレビューや、ユーザーが「/review-pr」「PR をレビューして」「コードレビューお願い」と言ったときに使う。PR 番号の指定がなければ現在のブランチの PR を自動検出する。
---

# Review PR

Pull Request のコードレビューを行うスキル。差分を取得し、変更内容に応じて最大6種のレビュアーを選定してレビューする。

## 引数の解析

- `/review-pr` → 現在のブランチに紐づく PR を自動検出
- `/review-pr 5` or `/review-pr #5` → PR #5 をレビュー

## レビュアー一覧

| # | レビュアー | 対象の判定基準 | チェック内容 |
|---|-----------|--------------|-------------|
| 1 | バグ・ロジック | コード (`.py`) 変更あり | エッジケース、None未処理、非同期問題、型不整合 |
| 2 | セキュリティ | コード (`.py`) 変更あり | ハードコード秘密情報、インジェクション、入力バリデーション、`.env` 混入 |
| 3 | スタイル・設計 | コード (`.py`) 変更あり | CLAUDE.md 規約との整合、命名規則、単一責任、テスト十分性 |
| 4 | ドキュメント | コード (`.py`) 変更あり | CLAUDE.md / README.md / docs/ への反映漏れ |
| 5 | ルール整合性 | コード (`.py`) 変更あり | `docs/game-rules.md` のルールと実装コード全体の整合性 |
| 6 | デザイナー | `templates/`, `static/`, `.html`, `.css`, `.js` 変更あり | UI/UXの一貫性、アクセシビリティ、レスポンシブ対応 |

## ワークフロー

### Step 1: PR の特定

引数がなければ現在のブランチの PR を探す:

```bash
gh pr view --json number,title,body,url
```

引数があればその番号を使う:

```bash
gh pr view <番号> --json number,title,body,url
```

### Step 2: 差分の取得

```bash
gh pr diff <番号>
```

差分が大きい場合はファイル単位で読み進める。

### Step 3: レビュアーの決定

差分の変更ファイル一覧から、どのレビュアーを起動するか判定する。

判定ルール:

1. `.py` ファイルの変更あり → **バグ・ロジック** + **セキュリティ** + **スタイル・設計** + **ドキュメント** + **ルール整合性**
2. `templates/`, `static/`, `.html`, `.css`, `.js` の変更あり → **デザイナー**

判定結果を以下の形式でユーザーに表示してからレビューを開始する:

```
該当レビュアー:
- [x] バグ・ロジック
- [x] セキュリティ
- [x] スタイル・設計
- [ ] ドキュメント
- [x] ルール整合性
- [ ] デザイナー
```

### Step 4: 各レビュアーによる並列レビュー実行

**Task ツールで該当する各レビュアーをサブエージェントとして並列に起動すること。**

手順:

1. 各レビュアーを `Task` ツール（`subagent_type: general-purpose`）で並列に起動する
   - 1つのメッセージで複数の Task 呼び出しを行い、並列実行する
2. 各サブエージェントのプロンプトには以下を含める:
   - PR 番号と差分内容（または差分の該当部分）
   - そのレビュアーのチェック観点（下記参照）
   - 「発見した問題を critical / warning / info に分類して報告せよ」という指示
3. 全サブエージェントの結果が返ってきたら Step 5 に進む

#### tox でカバー済み（レビュー対象外）

以下は `uv run tox` で自動チェックされるため、レビューでは指摘しない:

- **ruff format** — コードフォーマット（インデント、空行、引用符スタイル等）
- **ruff check** — リント違反（未使用インポート、命名規則等）
- **mypy** — 型ヒントの欠落、型の不整合
- **pytest** — テストの通過・失敗（テストが十分かどうかは別途レビュー対象）

#### 各レビュアーのチェック観点

**バグ・ロジックレビュー:**
- エッジケースの見落とし
- None/null の未処理
- 非同期処理の問題
- ※型の不整合は mypy でカバーされるため対象外

**セキュリティレビュー:**
- ハードコードされた秘密情報
- SQL インジェクション等の脆弱性
- ユーザー入力のバリデーション不足
- `.env` が含まれていないか

**スタイル・設計レビュー:**
- 既存アーキテクチャとの一貫性
- 単一責任原則
- テストの十分性（新機能・変更に対するテストが書かれているか）
- ※フォーマット・命名規則は ruff でカバーされるため対象外
- ※型ヒントの欠落は mypy でカバーされるため対象外

**ドキュメントレビュー:**
- コード変更に対応する CLAUDE.md の更新漏れ（新コマンド、設定変更など）
- README.md の更新漏れ（新機能、技術スタック変更など）
- docs/ 配下のドキュメント更新漏れ（ルール変更、用語追加など）

**ルール整合性レビュー:**
- `docs/game-rules.md` のルールと実装コードの整合性（`domain/` に限らず `session.py`, `engine/` 等も対象）
- 議論巡数、発言順、投票ルール、夜行動ルール等のゲーム進行ルール準拠
- `docs/glossary.md` の用語とコード上の命名の整合性
- 勝利条件、フェーズ遷移、役職能力などのルール準拠

**デザイナーレビュー:**
- UI/UX の一貫性（色、フォント、レイアウト）
- アクセシビリティ（alt 属性、コントラスト比、キーボード操作）
- レスポンシブ対応
- 既存デザインとの統一感

### Step 5: 結果の分類

発見した問題を3レベルに分類する:

1. **🔴 critical** — バグ・セキュリティ・ルール不整合。この PR で必ず修正すべき
2. **🟡 warning** — 品質改善。今回直せるなら直したい
3. **🔵 info** — 参考情報・将来の課題。Issue を作成して追跡

### Step 6: PR にレビューコメントを投稿

レビュー結果を PR のコメントとして投稿する。レビュー内容を記録として残すために、チャットでの報告だけでなく必ず PR にも投稿すること。

該当したレビュアーのセクションのみ含める。各セクション内で指摘をレベル別に記載し、最後にサマリーテーブルでまとめる:

```bash
gh pr comment <番号> --body "$(cat <<'EOF'
## コードレビュー結果

### バグ・ロジックレビュー
- 🔴 critical: <指摘内容>
- 🟡 warning: <指摘内容>
- 🔵 info: <指摘内容>
（指摘なし → ✅ 問題なし）

### セキュリティレビュー
- ✅ 問題なし

### スタイル・設計レビュー
- 🟡 warning: <指摘内容>

### ドキュメントレビュー
- ✅ 問題なし

### ルール整合性レビュー
- 🔵 info: <指摘内容>

### デザイナーレビュー
- ✅ 問題なし

---

### サマリー
| レベル | 件数 |
|--------|------|
| 🔴 critical | N |
| 🟡 warning | N |
| 🔵 info | N |
EOF
)"
```

全レビュアーで問題がなければ「✅ レビュー問題なし」と投稿する。

### Step 7: Issue の作成（info レベルの課題がある場合）

まず既存の Issue と重複がないか確認する:

```bash
gh issue list --state open --limit 50
```

既存 Issue のタイトル・内容と照合し、同等の課題が既に登録されている場合は新規作成せず、該当 Issue 番号を PR コメントで参照するだけにする。

重複がない場合のみ Issue を作成する:

```bash
gh issue create --title "<問題の簡潔な説明>" --body "$(cat <<'EOF'
## 背景
PR #<番号> のレビューで発見された問題。

## 問題の詳細
<指摘内容の詳細>

## 対応案
<推奨する対応方針>
EOF
)"
```

作成した Issue の番号と URL を PR コメントに追記、またはチャットで報告する。

### Step 8: 次のアクション提案

- 修正が必要な場合: `/fix-review` の実行を提案する
- 問題がない場合: ユーザーにマージ確認を促す
