---
name: review-pr
description: PR の差分を6種のレビュアー観点でレビューする。PR 作成後のレビューや、ユーザーが「/review-pr」「PR をレビューして」「コードレビューお願い」と言ったときに使う。PR 番号の指定がなければ現在のブランチの PR を自動検出する。
---

# Review PR

Pull Request のコードレビューを行うスキル。差分を取得し、変更内容に応じて最大6種のレビュアーを選定してレビューする。

## 引数の解析

- `/review-pr` → 現在のブランチに紐づく PR を自動検出
- `/review-pr 5` or `/review-pr #5` → PR #5 をレビュー

## レビュアー一覧

| # | レビュアー | 対象の判定基準 | チェック内容 |
|---|-----------|--------------|-------------|
| 1 | バグ・ロジック | コード (`.py`) 変更あり | エッジケース、None未処理、非同期問題、型不整合 |
| 2 | セキュリティ | コード (`.py`) 変更あり | ハードコード秘密情報、インジェクション、入力バリデーション、`.env` 混入 |
| 3 | スタイル・設計 | コード (`.py`) 変更あり | CLAUDE.md 規約との整合、命名規則、単一責任、テスト十分性 |
| 4 | ドキュメント | コード変更ありかつドキュメント変更なし | CLAUDE.md / README.md / docs/ への反映漏れ |
| 5 | ドメイン | `src/llm_werewolf/domain/` 変更あり | `docs/game-rules.md` のルールとコード実装の整合性 |
| 6 | デザイナー | `templates/`, `static/`, `.html`, `.css`, `.js` 変更あり | UI/UXの一貫性、アクセシビリティ、レスポンシブ対応 |

## ワークフロー

### Step 1: PR の特定

引数がなければ現在のブランチの PR を探す:

```bash
gh pr view --json number,title,body,url
```

引数があればその番号を使う:

```bash
gh pr view <番号> --json number,title,body,url
```

### Step 2: 差分の取得

```bash
gh pr diff <番号>
```

差分が大きい場合はファイル単位で読み進める。

### Step 3: レビュアーの決定

差分の変更ファイル一覧から、どのレビュアーを起動するか判定する。

判定ルール:

1. `.py` ファイルの変更あり → **バグ・ロジック** + **セキュリティ** + **スタイル・設計**
2. `.py` ファイルの変更ありかつ `CLAUDE.md`, `README.md`, `docs/` の変更なし → **ドキュメント**
3. `src/llm_werewolf/domain/` 配下の変更あり → **ドメイン**
4. `templates/`, `static/`, `.html`, `.css`, `.js` の変更あり → **デザイナー**

判定結果を以下の形式でユーザーに表示してからレビューを開始する:

```
該当レビュアー:
- [x] バグ・ロジック
- [x] セキュリティ
- [x] スタイル・設計
- [ ] ドキュメント
- [x] ドメイン
- [ ] デザイナー
```

### Step 4: 各レビュアーによるレビュー実行

該当するレビュアーのみ、それぞれの観点でレビューを実施する。

**バグ・ロジックレビュー:**
- エッジケースの見落とし
- None/null の未処理
- 非同期処理の問題
- 型の不整合

**セキュリティレビュー:**
- ハードコードされた秘密情報
- SQL インジェクション等の脆弱性
- ユーザー入力のバリデーション不足
- `.env` が含まれていないか

**スタイル・設計レビュー:**
- CLAUDE.md のコーディング規約との整合性
- 関数・変数の命名（スネークケース / パスカルケース）
- 不要なコードやコメント、型ヒントの欠落
- 既存アーキテクチャとの一貫性
- 単一責任原則
- テストの十分性

**ドキュメントレビュー:**
- コード変更に対応する CLAUDE.md の更新漏れ（新コマンド、設定変更など）
- README.md の更新漏れ（新機能、技術スタック変更など）
- docs/ 配下のドキュメント更新漏れ（ルール変更、用語追加など）

**ドメインレビュー:**
- `docs/game-rules.md` のルールとコード実装の整合性
- `docs/glossary.md` の用語とコード上の命名の整合性
- 勝利条件、フェーズ遷移、役職能力などのルール準拠

**デザイナーレビュー:**
- UI/UX の一貫性（色、フォント、レイアウト）
- アクセシビリティ（alt 属性、コントラスト比、キーボード操作）
- レスポンシブ対応
- 既存デザインとの統一感

### Step 5: 結果の分類

発見した問題を3カテゴリに分類する:

1. **必須修正** — バグやセキュリティ問題。この PR ですぐ直すべきもの
2. **推奨修正** — コード品質の改善。今回直せるなら直したいもの
3. **将来の課題** — 大きなリファクタリングが必要。Issue を作成して追跡するもの

### Step 6: PR にレビューコメントを投稿

レビュー結果を PR のコメントとして投稿する。レビュー内容を記録として残すために、チャットでの報告だけでなく必ず PR にも投稿すること。

該当したレビュアーのセクションのみ含める:

```bash
gh pr comment <番号> --body "$(cat <<'EOF'
## コードレビュー結果

### バグ・ロジックレビュー
- <指摘内容>（なければ「問題なし」）

### セキュリティレビュー
- <指摘内容>（なければ「問題なし」）

### スタイル・設計レビュー
- <指摘内容>（なければ「問題なし」）

### ドキュメントレビュー
- <指摘内容>（なければ「問題なし」）

### ドメインレビュー
- <指摘内容>（なければ「問題なし」）

### デザイナーレビュー
- <指摘内容>（なければ「問題なし」）

---

### 総合判定
- 必須修正: N件
- 推奨修正: N件
- 将来の課題: N件
EOF
)"
```

全レビュアーで問題がなければ「レビュー問題なし」と投稿する。

### Step 7: Issue の作成（将来の課題がある場合）

「将来の課題」に分類された問題は GitHub Issue を作成する:

```bash
gh issue create --title "<問題の簡潔な説明>" --body "$(cat <<'EOF'
## 背景
PR #<番号> のレビューで発見された問題。

## 問題の詳細
<指摘内容の詳細>

## 対応案
<推奨する対応方針>
EOF
)"
```

作成した Issue の番号と URL を PR コメントに追記、またはチャットで報告する。

### Step 8: 次のアクション提案

- 修正が必要な場合: `/fix-review` の実行を提案する
- 問題がない場合: ユーザーにマージ確認を促す
