{% macro past_day_details(past_days, past_discussions, past_events) %}
{% if past_days %}
<div class="past-discussion">
    {% for day in past_days %}
    <details>
        <summary>Day {{ day }}</summary>
        <div class="detail-content">
            {% if past_discussions.get(day) %}
            <ul class="message-list">
                {% for msg in past_discussions[day] %}
                <li>
                    <span class="speaker">{{ msg.split(': ', 1)[0] }}</span>:
                    {{ msg.split(': ', 1)[1] if ': ' in msg else msg }}
                </li>
                {% endfor %}
            </ul>
            {% endif %}
            {% if past_events.get(day) %}
            <div class="past-events-section">
                {% for event_type, event_text in past_events[day] %}
                    {% if event_type == "vote" %}
                    <div class="past-vote-entry">
                        <span class="vote-arrow">&rarr;</span> {{ event_text }}
                    </div>
                    {% elif event_type == "execution" %}
                    <div class="event-msg execution">{{ event_text }}</div>
                    {% elif event_type == "attack" %}
                    <div class="event-msg attack">{{ event_text }}</div>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </details>
    {% endfor %}
</div>
{% endif %}
{% endmacro %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM人狼 - ゲーム</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: "Helvetica Neue", Arial, "Yu Gothic", "Hiragino Kaku Gothic ProN", "メイリオ", Meiryo, sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
            min-height: 100vh;
        }
        .header {
            background-color: #16213e;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e94560;
        }
        .header h1 { font-size: 1.5rem; }
        .header .info { color: #a0a0b0; font-size: 0.9rem; }
        .main {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .panel {
            background-color: #16213e;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .panel h2 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: #e94560;
        }
        .players {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
        }
        .player-tag {
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.9rem;
            background-color: #1a1a2e;
        }
        .player-tag.alive { border-left: 3px solid #4ade80; }
        .player-tag.dead { border-left: 3px solid #ef4444; color: #999; text-decoration: line-through; }
        .player-tag.you { font-weight: bold; }
        .role-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 0.3rem;
        }
        .role-villager { background-color: #2563eb; }
        .role-seer { background-color: #7c3aed; }
        .role-werewolf { background-color: #dc2626; }
        .role-knight { background-color: #059669; }
        .role-medium { background-color: #d97706; }
        .role-madman { background-color: #be185d; }
        .message-list { list-style: none; }
        .message-list li {
            padding: 0.6rem 0;
            border-bottom: 1px solid #222;
        }
        .message-list li:last-child { border-bottom: none; }
        .speaker { font-weight: bold; color: #e94560; }
        .vote-list { list-style: none; }
        .vote-list li { padding: 0.4rem 0; }
        .vote-arrow { color: #e94560; margin: 0 0.3rem; }
        textarea {
            width: 100%;
            padding: 0.8rem;
            font-size: 1rem;
            border: 2px solid #333;
            border-radius: 8px;
            background-color: #1a1a2e;
            color: #e0e0e0;
            resize: vertical;
            min-height: 80px;
            outline: none;
        }
        textarea:focus { border-color: #e94560; }
        .btn {
            display: inline-block;
            padding: 0.8rem 2rem;
            font-size: 1.1rem;
            color: #fff;
            background-color: #e94560;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            text-decoration: none;
        }
        .btn:hover { background-color: #c73650; }
        .btn-secondary {
            background-color: #333;
        }
        .btn-secondary:hover { background-color: #444; }
        .radio-group label {
            display: block;
            padding: 0.7rem 1rem;
            margin-bottom: 0.5rem;
            background-color: #1a1a2e;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .radio-group label:hover { background-color: #222244; }
        .radio-group input[type="radio"] { margin-right: 0.5rem; }
        .result-box {
            text-align: center;
            padding: 2rem;
        }
        .result-box .winner {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .result-box .winner.village { color: #4ade80; }
        .result-box .winner.werewolf { color: #ef4444; }
        .event-msg {
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            background-color: #1a1a2e;
        }
        .event-msg.attack { border-left: 3px solid #ef4444; }
        .event-msg.divine { border-left: 3px solid #7c3aed; }
        .event-msg.execution { border-left: 3px solid #f59e0b; }
        .actions {
            text-align: center;
            margin-top: 1.5rem;
        }
        .past-discussion {
            margin-bottom: 1rem;
        }
        .past-discussion details {
            background-color: #16213e;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        .past-discussion summary {
            padding: 0.8rem 1rem;
            cursor: pointer;
            color: #a0a0b0;
            font-weight: bold;
            user-select: none;
        }
        .past-discussion summary:hover {
            color: #e0e0e0;
        }
        .past-discussion .detail-content {
            padding: 0 1rem 0.8rem;
        }
        .past-events-section {
            margin-top: 0.8rem;
            padding-top: 0.8rem;
            border-top: 1px solid #333;
        }
        .past-vote-entry {
            padding: 0.2rem 0;
            color: #c0c0d0;
            font-size: 0.95rem;
        }
        .dead-notice {
            text-align: center;
            padding: 1rem;
            color: #ef4444;
            font-size: 1.1rem;
        }
        .btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        .btn:disabled:hover {
            background-color: #555;
        }
        .loading-spinner {
            display: inline-block;
            width: 1.2rem;
            height: 1.2rem;
            border: 3px solid #555;
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
            margin-left: 0.5rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @media (max-width: 600px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 0.8rem 1rem;
            }
            .header .info { margin-top: 0.5rem; }
            .main { padding: 0 0.5rem; margin: 1rem auto; }
            .past-discussion summary {
                padding: 0.6rem 0.8rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>LLM人狼</h1>
        <div class="info">
            Day {{ game.day }} /
            {% if human_player %}
                {{ human_player.name }}
                {% if human_player.is_alive %}(生存){% else %}(死亡){% endif %}
            {% endif %}
        </div>
    </div>

    <div class="main">
        <!-- プレイヤーパネル -->
        <div class="panel">
            <h2>プレイヤー</h2>
            <div class="players">
                {% for p in ordered_players %}
                <div class="player-tag {{ 'alive' if p.is_alive else 'dead' }} {{ 'you' if p.name == session.human_player_name else '' }}">
                    {{ p.name }}
                    {% if p.name == session.human_player_name %}
                        <span class="role-badge role-{{ p.role.value }}">{{ p.role.value }}</span>
                    {% elif step == "game_over" %}
                        <span class="role-badge role-{{ p.role.value }}">{{ p.role.value }}</span>
                    {% elif p in werewolf_allies %}
                        <span class="role-badge role-{{ p.role.value }}">{{ p.role.value }}</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- ROLE_REVEAL: 配役表示 -->
        {% if step == "role_reveal" %}
        <div class="panel">
            <h2>配役結果</h2>
            <p style="text-align: center; font-size: 1.3rem; margin: 1.5rem 0;">
                あなたの役職は
                <span class="role-badge role-{{ human_player.role.value }}" style="font-size: 1.2rem; padding: 0.4rem 0.8rem;">
                    {% if human_player.role.value == "villager" %}村人
                    {% elif human_player.role.value == "seer" %}占い師
                    {% elif human_player.role.value == "werewolf" %}人狼
                    {% elif human_player.role.value == "knight" %}狩人
                    {% elif human_player.role.value == "medium" %}霊媒師
                    {% elif human_player.role.value == "madman" %}狂人
                    {% endif %}
                </span>
                です
            </p>
            {% if werewolf_allies %}
            <p style="text-align: center; margin-top: 1rem; color: #ef4444;">
                仲間の人狼: {% for ally in werewolf_allies %}{{ ally.name }}{% if not loop.last %}、{% endif %}{% endfor %}
            </p>
            {% endif %}
            <div class="actions">
                <form action="/play/{{ game_id }}/next" method="post">
                    <button type="submit" class="btn">ゲーム開始</button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- DISCUSSION: 議論フェーズ -->
        {% if step == "discussion" %}
        {{ past_day_details(past_days, past_discussions, past_events) }}
        <div class="panel">
            <h2>議論 - Day {{ game.day }}</h2>
            {% if session.current_discussion %}
            <ul class="message-list">
                {% for msg in session.current_discussion %}
                <li>
                    <span class="speaker">{{ msg.split(': ', 1)[0] }}</span>:
                    {{ msg.split(': ', 1)[1] if ': ' in msg else msg }}
                </li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>

        {% if human_is_alive %}
        <div class="panel">
            <h2>あなたの発言</h2>
            <form action="/play/{{ game_id }}/discuss" method="post">
                <textarea name="message" placeholder="発言を入力してください..."></textarea>
                <div class="actions">
                    <button type="submit" class="btn">発言する</button>
                </div>
            </form>
        </div>
        {% else %}
        <div class="dead-notice">あなたは死亡しているため発言できません</div>
        <div class="actions">
            <form action="/play/{{ game_id }}/next" method="post">
                <button type="submit" class="btn btn-secondary">次へ</button>
            </form>
        </div>
        {% endif %}
        {% endif %}

        <!-- VOTE: 投票フェーズ -->
        {% if step == "vote" %}
        {{ past_day_details(past_days, past_discussions, past_events) }}
        {% if session.current_discussion %}
        <div class="panel">
            <h2>議論 - Day {{ game.day }}</h2>
            <ul class="message-list">
                {% for msg in session.current_discussion %}
                <li>
                    <span class="speaker">{{ msg.split(': ', 1)[0] }}</span>:
                    {{ msg.split(': ', 1)[1] if ': ' in msg else msg }}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        <div class="panel">
            <h2>投票 - Day {{ game.day }}</h2>
            {% if human_is_alive %}
            <p style="margin-bottom: 1rem;">処刑する人を選んでください:</p>
            <form action="/play/{{ game_id }}/vote" method="post">
                <div class="radio-group">
                    {% for p in vote_candidates %}
                    <label>
                        <input type="radio" name="target" value="{{ p.name }}" required>
                        {{ p.name }}
                    </label>
                    {% endfor %}
                </div>
                <div class="actions">
                    <button type="submit" class="btn">投票する</button>
                </div>
            </form>
            {% else %}
            <div class="dead-notice">あなたは死亡しているため投票できません</div>
            <div class="actions">
                <form action="/play/{{ game_id }}/next" method="post">
                    <button type="submit" class="btn btn-secondary">次へ</button>
                </form>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- EXECUTION_RESULT: 処刑結果 -->
        {% if step == "execution_result" %}
        <div class="panel">
            <h2>投票結果 - Day {{ game.day }}</h2>
            {% if session.current_votes %}
            <ul class="vote-list">
                {% for voter, target in session.current_votes.items() %}
                <li>{{ voter }} <span class="vote-arrow">&rarr;</span> {{ target }}</li>
                {% endfor %}
            </ul>
            {% endif %}
            <div style="margin-top: 1rem;">
                {% for log_line in current_execution_logs %}
                <div class="event-msg execution">{{ log_line }}</div>
                {% endfor %}
            </div>
            <div class="actions">
                <form action="/play/{{ game_id }}/next" method="post">
                    <button type="submit" class="btn">{% if session.winner %}結果を見る{% else %}夜へ{% endif %}</button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- NIGHT_ACTION: 夜行動選択 -->
        {% if step == "night_action" %}
        {{ past_day_details(past_days, past_discussions, past_events) }}
        <div class="past-discussion">
            <details>
                <summary>Day {{ game.day }}（今日）</summary>
                <div class="detail-content">
                    {% if session.current_discussion %}
                    <ul class="message-list">
                        {% for msg in session.current_discussion %}
                        <li>
                            <span class="speaker">{{ msg.split(': ', 1)[0] }}</span>:
                            {{ msg.split(': ', 1)[1] if ': ' in msg else msg }}
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                    {% if session.current_votes %}
                    <div class="past-events-section">
                        {% for voter, target in session.current_votes.items() %}
                        <div class="past-vote-entry">
                            <span class="vote-arrow">&rarr;</span> {{ voter }} → {{ target }}
                        </div>
                        {% endfor %}
                        {% for log_line in current_execution_logs %}
                        <div class="event-msg execution">{{ log_line }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </details>
        </div>
        <div class="panel">
            {% if night_action_type == "divine" %}
            <h2>占い - Night {{ game.day }}</h2>
            <p style="margin-bottom: 1rem;">占う対象を選んでください:</p>
            <form action="/play/{{ game_id }}/night-action" method="post">
                <div class="radio-group">
                    {% for p in night_action_candidates %}
                    <label>
                        <input type="radio" name="target" value="{{ p.name }}" required>
                        {{ p.name }}
                    </label>
                    {% endfor %}
                </div>
                <div class="actions">
                    <button type="submit" class="btn">占う</button>
                </div>
            </form>
            {% elif night_action_type == "attack" %}
            <h2>襲撃 - Night {{ game.day }}</h2>
            {% if werewolf_allies %}
            <p style="margin-bottom: 1rem; color: #ef4444;">
                仲間の人狼: {% for ally in werewolf_allies %}{{ ally.name }}{% if not loop.last %}、{% endif %}{% endfor %}
            </p>
            {% endif %}
            <p style="margin-bottom: 1rem;">襲撃する対象を選んでください:</p>
            <form action="/play/{{ game_id }}/night-action" method="post">
                <div class="radio-group">
                    {% for p in night_action_candidates %}
                    <label>
                        <input type="radio" name="target" value="{{ p.name }}" required>
                        {{ p.name }}
                    </label>
                    {% endfor %}
                </div>
                <div class="actions">
                    <button type="submit" class="btn">襲撃する</button>
                </div>
            </form>
            {% elif night_action_type == "guard" %}
            <h2>護衛 - Night {{ game.day }}</h2>
            <p style="margin-bottom: 1rem;">護衛する対象を選んでください:</p>
            <form action="/play/{{ game_id }}/night-action" method="post">
                <div class="radio-group">
                    {% for p in night_action_candidates %}
                    <label>
                        <input type="radio" name="target" value="{{ p.name }}" required>
                        {{ p.name }}
                    </label>
                    {% endfor %}
                </div>
                <div class="actions">
                    <button type="submit" class="btn">護衛する</button>
                </div>
            </form>
            {% endif %}
        </div>
        {% endif %}

        <!-- NIGHT_RESULT: 夜フェーズ結果 -->
        {% if step == "night_result" %}
        <div class="panel">
            <h2>夜の結果 - Night {{ game.day - 1 }}</h2>
            {% if session.night_messages %}
                {% for msg in session.night_messages %}
                <div class="event-msg attack">{{ msg }}</div>
                {% endfor %}
            {% else %}
                <p>今夜は何も起きなかった...</p>
            {% endif %}

            {% if human_player and human_player.role.value == "seer" and human_player.is_alive %}
                {% set history = game.get_divined_history(human_player.name) %}
                {% if history %}
                    {% set last_target = history[-1] %}
                    {% for p in game.players %}
                        {% if p.name == last_target %}
                            <div class="event-msg divine" style="margin-top: 1rem;">
                                占い結果: {{ last_target }} は
                                {% if p.role.value == "werewolf" %}人狼{% else %}人狼ではない{% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endif %}

            {% if human_player and human_player.role.value == "medium" and human_player.is_alive %}
                {% if game.medium_results %}
                    {% set last_result = game.medium_results[-1] %}
                    <div class="event-msg divine" style="margin-top: 1rem;">
                        霊媒結果: {{ last_result[1] }} は
                        {% if last_result[2] %}人狼{% else %}人狼ではない{% endif %}
                    </div>
                {% endif %}
            {% endif %}

            <div class="actions">
                <form action="/play/{{ game_id }}/next" method="post">
                    <button type="submit" class="btn">次の日へ</button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- GAME_OVER: ゲーム終了 -->
        {% if step == "game_over" %}
        <div class="panel">
            <div class="result-box">
                {% if session.winner and session.winner.value == "village" %}
                <div class="winner village">村人陣営の勝利!</div>
                {% elif session.winner and session.winner.value == "werewolf" %}
                <div class="winner werewolf">人狼陣営の勝利!</div>
                {% endif %}

                <h2 style="margin: 1.5rem 0 1rem;">配役公開</h2>
                <div class="players" style="justify-content: center;">
                    {% for p in ordered_players %}
                    <div class="player-tag {{ 'alive' if p.is_alive else 'dead' }}">
                        {{ p.name }}
                        <span class="role-badge role-{{ p.role.value }}">{{ p.role.value }}</span>
                    </div>
                    {% endfor %}
                </div>

                <div class="actions" style="margin-top: 2rem;">
                    <a href="/" class="btn">トップに戻る</a>
                    <a href="/play/{{ game_id }}/export" class="btn btn-secondary" download style="margin-left: 0.5rem;">ログをダウンロード</a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    <div id="sse-loading" style="display:none; text-align:center; margin-top:1rem;">
        <span class="loading-spinner"></span>
        <span id="sse-loading-text" style="margin-left:0.5rem;">準備中...</span>
    </div>
    <script>
        // SSE エンドポイントのマッピング
        var SSE_ENDPOINTS = {
            '/next': '/sse/next',
            '/discuss': '/sse/discuss',
            '/vote': '/sse/vote',
            '/night-action': '/sse/night-action'
        };

        // SSE レスポンスのテキストをパースしてイベントに分割
        function parseSSEEvents(text) {
            var events = [];
            var blocks = text.split('\n\n');
            for (var i = 0; i < blocks.length; i++) {
                var block = blocks[i].trim();
                if (!block) continue;
                var eventType = '';
                var data = '';
                var lines = block.split('\n');
                for (var j = 0; j < lines.length; j++) {
                    if (lines[j].indexOf('event: ') === 0) {
                        eventType = lines[j].substring(7);
                    } else if (lines[j].indexOf('data: ') === 0) {
                        data = lines[j].substring(6);
                    }
                }
                if (eventType && data) {
                    try { events.push({type: eventType, data: JSON.parse(data)}); }
                    catch(e) { /* ignore parse errors */ }
                }
            }
            return events;
        }

        // 議論リストに発言を追加
        function appendMessage(player, text) {
            var list = document.querySelector('.message-list');
            if (!list) {
                // message-list がなければ作成
                var panel = document.querySelector('.panel h2');
                if (panel && panel.parentNode) {
                    list = document.createElement('ul');
                    list.className = 'message-list';
                    panel.parentNode.appendChild(list);
                } else {
                    return;
                }
            }
            var li = document.createElement('li');
            var speaker = document.createElement('span');
            speaker.className = 'speaker';
            speaker.textContent = player;
            li.appendChild(speaker);
            li.appendChild(document.createTextNode(': ' + text));
            list.appendChild(li);
        }

        // ACTION_LABELS マッピング
        var ACTION_LABELS = {
            'discuss': 'が考え中...',
            'vote': 'が投票中...',
            'divine': 'が占い中...',
            'guard': 'が護衛先を決定中...',
            'attack': 'が襲撃先を決定中...',
            'summarize': ' 盤面を整理中...'
        };

        function getLoadingText(player, action) {
            var label = ACTION_LABELS[action] || 'が処理中...';
            return player + label;
        }

        // SSE で form を送信
        function submitWithSSE(form) {
            var action = form.getAttribute('action');
            // SSE エンドポイントのパスを構築
            var sseAction = null;
            for (var suffix in SSE_ENDPOINTS) {
                if (action.endsWith(suffix)) {
                    sseAction = action.replace(new RegExp(suffix.replace('/', '\\/') + '$'), SSE_ENDPOINTS[suffix]);
                    break;
                }
            }
            if (!sseAction) return false; // SSE 対象外

            var formData = new FormData(form);
            var loadingEl = document.getElementById('sse-loading');
            var loadingText = document.getElementById('sse-loading-text');

            // UI をロック
            var btn = form.querySelector('button[type="submit"]');
            if (btn) btn.disabled = true;
            var textarea = form.querySelector('textarea');
            if (textarea) textarea.readOnly = true;
            form.querySelectorAll('input[type="radio"]').forEach(function(r) { r.disabled = true; });
            loadingEl.style.display = 'block';
            loadingText.textContent = '準備中...';

            // form の後ろにローディング表示を移動
            form.parentNode.insertBefore(loadingEl, form.nextSibling);

            fetch(sseAction, {
                method: 'POST',
                body: formData
            }).then(function(response) {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                var reader = response.body.getReader();
                var decoder = new TextDecoder();
                var buffer = '';

                function read() {
                    return reader.read().then(function(result) {
                        if (result.done) {
                            // ストリーム終了 — リロード
                            location.reload();
                            return;
                        }
                        buffer += decoder.decode(result.value, {stream: true});
                        var events = parseSSEEvents(buffer);
                        // 最後のイベントまでの部分を消費、未完成ブロックは残す
                        var lastDoubleNewline = buffer.lastIndexOf('\n\n');
                        if (lastDoubleNewline >= 0) {
                            buffer = buffer.substring(lastDoubleNewline + 2);
                        }
                        for (var i = 0; i < events.length; i++) {
                            var ev = events[i];
                            if (ev.type === 'progress') {
                                loadingText.textContent = getLoadingText(ev.data.player, ev.data.action);
                            } else if (ev.type === 'message') {
                                appendMessage(ev.data.player, ev.data.text);
                            } else if (ev.type === 'done') {
                                location.reload();
                                return;
                            }
                        }
                        return read();
                    });
                }
                return read();
            }).catch(function(err) {
                // SSE 失敗時: 従来のフォーム送信にフォールバック
                console.error('SSE error:', err);
                loadingEl.style.display = 'none';
                if (btn) btn.disabled = false;
                if (textarea) textarea.readOnly = false;
                form.querySelectorAll('input[type="radio"]').forEach(function(r) { r.disabled = false; });
                form.submit();
            });

            return true;
        }

        document.querySelectorAll('form').forEach(function(form) {
            var submitted = false;
            form.addEventListener('submit', function(e) {
                if (submitted) {
                    e.preventDefault();
                    return;
                }
                submitted = true;
                e.preventDefault();
                if (!submitWithSSE(form)) {
                    // SSE 対象外のフォームは通常送信
                    form.submit();
                }
            });
        });
    </script>
</body>
</html>
